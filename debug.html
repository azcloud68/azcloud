<!DOCTYPE html>
<html>
<head>
  <title>AZCloud Proxy Debug Tool</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .log { background: #f5f5f5; padding: 15px; border-radius: 5px; margin-top: 20px; }
    .success { color: green; }
    .error { color: red; }
    button { padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>üîç AZCloud Proxy Debug Tool</h1>
  
  <div>
    <h3>1. Ki·ªÉm tra Service Worker</h3>
    <button id="check-sw">Test Service Worker</button>
    <div id="sw-status" class="log"></div>
  </div>

  <div>
    <h3>2. Ki·ªÉm tra Whitelist File</h3>
    <button id="check-whitelist">Load Whitelist</button>
    <div id="whitelist-status" class="log"></div>
  </div>

  <div>
    <h3>3. Test Proxy Request</h3>
    <input type="text" id="repo-url" placeholder="Nh·∫≠p URL (vd: /gh/azcloud68/my-cdn-test@main/test.jpg)" style="width: 400px; padding: 8px;">
    <button id="test-proxy">Test Proxy</button>
    <div id="proxy-status" class="log"></div>
    <img id="test-image" style="max-width: 300px; margin-top: 10px; display: none;">
  </div>

  <div>
    <h3>4. Log to√†n b·ªô qu√° tr√¨nh</h3>
    <pre id="full-log"></pre>
  </div>

  <script>
    const fullLog = document.getElementById('full-log');
    const addLog = (message, type = 'info') => {
      const logEntry = `[${new Date().toLocaleTimeString()}] ${message}\n`;
      fullLog.textContent += logEntry;
      console.log(`[${type.toUpperCase()}] ${message}`);
    };

    // 1. Ki·ªÉm tra Service Worker
    document.getElementById('check-sw').addEventListener('click', async () => {
      const statusDiv = document.getElementById('sw-status');
      statusDiv.innerHTML = '';
      addLog('B·∫Øt ƒë·∫ßu ki·ªÉm tra Service Worker...');
      
      try {
        if (!('serviceWorker' in navigator)) {
          throw new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Service Worker');
        }

        const registration = await navigator.serviceWorker.register('/sw.js');
        addLog('ƒêƒÉng k√Ω Service Worker th√†nh c√¥ng', 'success');
        statusDiv.innerHTML = '<p class="success">‚úÖ Service Worker ho·∫°t ƒë·ªông</p>';
        
        // Ki·ªÉm tra n·∫øu SW ƒë√£ active
        if (registration.active) {
          addLog('Service Worker ƒëang ch·∫°y', 'success');
        } else {
          addLog('Service Worker ch∆∞a active, c·∫ßn refresh trang', 'warning');
        }
      } catch (error) {
        addLog(`L·ªói Service Worker: ${error.message}`, 'error');
        statusDiv.innerHTML = `<p class="error">‚ùå ${error.message}</p>`;
      }
    });

    // 2. Ki·ªÉm tra Whitelist
    document.getElementById('check-whitelist').addEventListener('click', async () => {
      const statusDiv = document.getElementById('whitelist-status');
      statusDiv.innerHTML = '';
      addLog('B·∫Øt ƒë·∫ßu t·∫£i whitelist...');
      
      try {
        const response = await fetch('/allowed-repos.enc');
        addLog(`HTTP Status: ${response.status}`, 'info');
        
        if (!response.ok) {
          throw new Error(`L·ªói HTTP: ${response.status}`);
        }

        const data = await response.json();
        addLog('Nh·∫≠n d·ªØ li·ªáu m√£ h√≥a th√†nh c√¥ng', 'success');
        addLog(`IV: ${data.iv}`, 'info');
        addLog(`D·ªØ li·ªáu m√£ h√≥a (50 k√Ω t·ª± ƒë·∫ßu): ${data.encryptedData.substring(0, 50)}...`, 'info');
        
        statusDiv.innerHTML = `
          <p class="success">‚úÖ File whitelist t·ªìn t·∫°i</p>
          <p>ƒê·ªô d√†i d·ªØ li·ªáu: ${data.encryptedData.length} bytes</p>
        `;
      } catch (error) {
        addLog(`L·ªói t·∫£i whitelist: ${error.message}`, 'error');
        statusDiv.innerHTML = `<p class="error">‚ùå ${error.message}</p>`;
      }
    });

    // 3. Test Proxy
    document.getElementById('test-proxy').addEventListener('click', async () => {
      const url = document.getElementById('repo-url').value.trim();
      const statusDiv = document.getElementById('proxy-status');
      const imgElement = document.getElementById('test-image');
      statusDiv.innerHTML = '';
      imgElement.style.display = 'none';
      
      if (!url) {
        addLog('Vui l√≤ng nh·∫≠p URL', 'error');
        return;
      }

      addLog(`ƒêang test proxy v·ªõi URL: ${url}...`);
      
      try {
        const response = await fetch(url);
        addLog(`HTTP Status: ${response.status}`, 'info');
        
        if (!response.ok) {
          throw new Error(`L·ªói t·ª´ server: ${response.status}`);
        }

        const contentType = response.headers.get('content-type');
        addLog(`Content-Type: ${contentType}`, 'info');
        
        if (contentType.includes('image')) {
          const blob = await response.blob();
          const imgUrl = URL.createObjectURL(blob);
          imgElement.src = imgUrl;
          imgElement.style.display = 'block';
          statusDiv.innerHTML = '<p class="success">‚úÖ Proxy th√†nh c√¥ng (xem ·∫£nh ph√≠a tr√™n)</p>';
          addLog('Proxy ·∫£nh th√†nh c√¥ng', 'success');
        } else {
          const text = await response.text();
          statusDiv.innerHTML = `<pre>${text}</pre>`;
          addLog('D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng ph·∫£i ·∫£nh', 'warning');
        }
      } catch (error) {
        addLog(`L·ªói proxy: ${error.message}`, 'error');
        statusDiv.innerHTML = `<p class="error">‚ùå ${error.message}</p>`;
      }
    });

    // T·ª± ƒë·ªông ƒëƒÉng k√Ω SW khi t·∫£i trang
    window.addEventListener('load', () => {
      addLog('Trang ƒë√£ t·∫£i xong, ki·ªÉm tra Service Worker...');
      document.getElementById('check-sw').click();
    });
  </script>
</body>
</html>
