<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Proxy Ảnh - Phương án 3</title>
  <style>
    .image-container {
      margin: 20px 0;
    }
    .proxy-image {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
    }
    .loading {
      background: #f5f5f5;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <h1>Proxy Ảnh - Phương án 3</h1>
  <p>Sử dụng Redirect HTML + Service Worker</p>

  <div class="image-container">
    <img class="proxy-image"
         src="/gh/redirect.html?img=azcloud68/my-cdn-test@main/images/test1.jpg"
         alt="Ảnh test 1"
         onerror="directImageLoad(this)"
         loading="lazy">
  </div>

  <script>
    function directImageLoad(img) {
      // Chuyển sang dùng link jsDelivr trực tiếp khi redirect thất bại
      const src = img.src;
      if (src.includes('/gh/redirect.html')) {
        const imgPath = new URL(src).searchParams.get('img');
        if (imgPath) {
          img.src = `https://cdn.jsdelivr.net/gh/${imgPath}`;
        }
      }
    }

    // Đăng ký Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { scope: '/' })
        .then(registration => {
          console.log('SW registered');
        })
        .catch(err => {
          console.error('SW registration failed:', err);
        });
    }
  </script>
</body>
</html>
